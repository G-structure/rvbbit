name: Build and Push Docker Image

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Leiningen
        run: |
          curl -O https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
          chmod +x lein
          sudo mv lein /usr/local/bin/
          lein version

      - name: Generate build ID
        run: |
          BUILD_NUMBER=0
          if [ -f "build_number.txt" ]; then
            BUILD_NUMBER=$(cat "build_number.txt")
          fi
          BUILD_NUMBER=$((BUILD_NUMBER + 1))
          echo "$BUILD_NUMBER" > "build_number.txt"
          BUILD_ID=$(date +%s)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          echo "(ns rvbbit-frontend.build-id) (def build-id \"$BUILD_ID\") (def build-date \"$BUILD_DATE\") (def build-number $BUILD_NUMBER)" > frontend/src/rvbbit_frontend/build_id.cljs
          echo "(ns rvbbit-backend.build-id) (def build-id \"$BUILD_ID\") (def build-date \"$BUILD_DATE\") (def build-number $BUILD_NUMBER)" > backend/src/rvbbit_backend/build_id.clj

      - name: Build Frontend
        run: |
          cd frontend
          npm install
          rm -rf .shadow-cljs
          npx shadow-cljs release app
          cd ..
          rm -rf backend/resources/public/
          cp -r frontend/resources/public backend/resources/public
          rm -rf backend/resources/public/images/gen/
          rm -rf backend/resources/public/images/large/

      - name: Build Backend Uberjar
        env:
          LEIN_SNAPSHOTS_IN_RELEASE: true
        run: |
          cd backend
          mkdir -p target db data/atoms
          lein clean
          lein uberjar
          find ./target -name "rvbbit*standalone.jar" -exec cp {} rvbbit.jar \;

      - name: Prepare Docker staging
        run: |
          VERSION=$(grep -m1 'defproject' backend/project.clj | sed 's/^[^"]*"//' | sed 's/".*//')
          DIR_NAME="rvbbit-$VERSION"
          rm -rf "$DIR_NAME" docker-staging
          mkdir -p "$DIR_NAME"

          cd backend
          cp -r assets "../$DIR_NAME/assets"
          cp -r connections "../$DIR_NAME/connections"
          cp -r data "../$DIR_NAME/data"
          mkdir -p "../$DIR_NAME/db"
          cp -r defs "../$DIR_NAME/defs"
          cp -r ai-workers "../$DIR_NAME/ai-workers"
          mv "../$DIR_NAME/defs/empty-secrets.edn" "../$DIR_NAME/defs/secrets.edn" || true
          cp -r flows "../$DIR_NAME/flows"
          cp -r themes "../$DIR_NAME/themes"
          cp -r extras "../$DIR_NAME/extras"
          cp -r resources "../$DIR_NAME/resources"
          cp -r screens "../$DIR_NAME/screens"
          cp user.clj "../$DIR_NAME/"
          cp run-rabbit.sh "../$DIR_NAME/"
          cp rvbbit.jar "../$DIR_NAME/"
          cd ..

          rm -rf "$DIR_NAME/assets/data-exports" "$DIR_NAME/assets/snaps"
          rm -rf "$DIR_NAME/data/atoms" "$DIR_NAME/defs/backup"
          rm -f "$DIR_NAME/defs/secrets.edn"
          rm -rf "$DIR_NAME/extras/node-colorthief/node_modules"
          rm -f "$DIR_NAME/extras/node-colorthief/package-lock.json"
          mkdir -p "$DIR_NAME/data/atoms" "$DIR_NAME/assets/data-exports"

          mkdir -p docker-staging
          cp -r "$DIR_NAME"/* docker-staging/

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=
            type=ref,event=branch

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
